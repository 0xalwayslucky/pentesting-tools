# /usr/bin/env python3
# interactive xp_cmdshell
# with impacket and cmd
# used https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py for reference
import os, cmd, sys
from impacket import tds
import readline

username = ''                                                                
password = ''                                               
domain = ''
ip = '127.0.0.1'                                                            
port = 1433

cmd_builder = '{}'

# pass commands directly into powershell
# ./xp_cmdshell.py -powershell
if len(sys.argv) > 1 and sys.argv[1] == '-powershell':
    cmd_builder = cmd_builder.format('powershell -command "{}"')

if __name__ == '__main__':
    class XpShell(cmd.Cmd):
        def __init__(self, SQLObj):
            cmd.Cmd.__init__(self)
            self.sql = SQLObj
            self.prompt = 'xp_cmd> '
            self.file = None

        # interpret every line as system command
        def default(self, arg):
            try:
                self.sql.sql_query("exec master..xp_cmdshell '{}'".format(cmd_builder.format(arg)))
                self.sql.printReplies()
                self.sql.colMeta[0]['TypeData'] = 80*2
                self.sql.printRows()
            except:
                pass

        # i wont say what it does
        def do_exit(self, arg):
            exit()

        # ? yes
        def do_help(self, arg):
            print("""
    you found the help command
    prefix <pre>    -   set prefix for every following command
    exit            -   i wont say what it does
                  """)

        # set custom prefix for every command passed to xp_cmdshell
        # this overwrites -powershell
        def do_prefix(self, arg):
            global cmd_builder
            cmd_builder = '{}'.format(arg)
            print('new prefix: {}'.format(cmd_builder))
            cmd_builder += ' {}'


    # do database connection (simple for now)
    try:
        ms_sql = tds.MSSQL(ip, port)
        ms_sql.connect()
        res = ms_sql.login(database = None, username = username, password = password, domain = domain)
        ms_sql.printReplies()

        # if connection successful
        if res is True:
            shell = XpShell(ms_sql)
            shell.cmdloop()
    except Exception as e:                                                         
        print('Exception: ')
        print(str(e))

    # close ms_sql 
    ms_sql.disconnect()
