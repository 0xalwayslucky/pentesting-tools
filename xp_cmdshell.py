# /usr/bin/env python3
# interactive xp_cmdshell
# with impacket and cmd
# used https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py for reference
import os, cmd, sys, re, base64
from impacket import tds
import readline


username = ''                                                                
password = ''                                               
domain = '' # optional
ip = '127.0.0.1'                                                            
port = 1433
pwsh = False


if __name__ == '__main__':
    class XpShell(cmd.Cmd):
        def __init__(self, SQLObj):
            cmd.Cmd.__init__(self)
            self.sql = SQLObj
            self.prompt = 'xp_cmd> '
            self.file = None

        # interpret every line as system command
        def default(self, arg):
            try:

                if pwsh: 
                    new_arg = 'powershell -encodedCommand {}'
                    arg = new_arg.format(powershell_encode(arg))

                self.execute_query(arg)

            except ConnectionResetError as e:
                print('connection lost attempting to reconnect...')
                self.sql.disconnect()
                ms_sql, res = connect_mssql()
                if res is True:
                    self.sql = ms_sql
                    print('Success!')
                    self.execute_query(arg)
                else:
                    print('Could not re-establish connection. Exiting.')
                    exit()

            except Exception as e:
                print('Exception: ')
                print(str(e))
                pass

        # i wont say what it does
        def do_exit(self, arg):
            exit()

        def do_pwsh(self, arg):
            global pwsh
            pwsh = False if pwsh else True
            print('powershell : {}'.format(pwsh))

        # ? yes
        def do_help(self, arg):
            print("""
    you found the help command

    pwsh    -   Toggle powershell on/off
    exit    -   i wont say what it does
                  """)

        def execute_query(self, arg):
            self.sql.sql_query("exec master..xp_cmdshell '{}'".format(arg))
            self.sql.printReplies()
            self.sql.colMeta[0]['TypeData'] = 80*2
            self.sql.printRows()



    # pass commands directly into powershell
    # ./xp_cmdshell.py -powershell
    if len(sys.argv) > 1 and sys.argv[1] == '-powershell':
        pwsh = True

        
    # reference https://github.com/darkoperator/powershell_scripts/blob/master/ps_encoder.py
    def powershell_encode(data):
        powershell_command = ""

        # loop through each character and insert null byte
        for char in data: powershell_command += char + "\x00"
        return base64.b64encode(powershell_command.encode()).decode("utf-8")


    def connect_mssql():
        # do database connection (simple for now)
        try:
            ms_sql = tds.MSSQL(ip, port)
            ms_sql.connect()
            res = ms_sql.login(database = None, username = username, password = password, domain = domain)
            ms_sql.printReplies()
            return ms_sql, res

        except Exception as e:                                                         
            print('Exception: ')
            print(str(e))


    # if connection successful
    ms_sql, res = connect_mssql()
    if res is True:
        shell = XpShell(ms_sql)
        shell.cmdloop()
    # close ms_sql 
    ms_sql.disconnect()
