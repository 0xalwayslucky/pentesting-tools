# interactive xp_cmdshell
# with impacket and cmd
# used https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py for reference
import os, cmd 
from impacket import tds
import readline

username = ''                                                                
password = ''                                               
domain = ''
ip = '127.0.0.1'                                                            
port = 1433

if __name__ == '__main__':
    class XpShell(cmd.Cmd):
        def __init__(self, SQLObj):
            cmd.Cmd.__init__(self)
            self.sql = SQLObj
            self.prompt = 'xp_cmd> '
            self.file = None

        # interpret every line as system command
        def default(self, arg):
            try:
                self.sql.sql_query("exec master..xp_cmdshell '{}'".format(arg))
                self.sql.printReplies()
                self.sql.colMeta[0]['TypeData'] = 80*2
                self.sql.printRows()
            except:
                pass

        # i wont say what it does
        def do_exit(self, arg):
            exit()

        # ? yes
        def do_help(self, arg):
            print("""
    you found the help command
                  """)


    # do database connection (simple for now)
    try:
        ms_sql = tds.MSSQL(ip, port)
        ms_sql.connect()
        res = ms_sql.login(database = None, username = username, password = password, domain = domain)
        ms_sql.printReplies()

        # if connection successful
        if res is True:
            shell = XpShell(ms_sql)
            shell.cmdloop()
    except Exception as e:                                                         
        print('Exception: ')
        print(str(e))

    # close ms_sql 
    ms_sql.disconnect()
